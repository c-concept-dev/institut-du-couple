<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clone de Personnalit√© v8.0 ULTIMATE - Institut du Couple</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================
           CSS VARIABLES - INSTITUT DU COUPLE
        ============================================ */
        :root {
            /* Institut du Couple Palette */
            --primary: #8FAFB1;           /* Mer - Bleu-Vert Doux */
            --primary-dark: #7A9A9C;      /* Mer fonc√© */
            --secondary: #C8D0C3;         /* Vert Sauge Clair */
            --accent-warm: #D8CDBB;       /* Beige Sable */
            --accent-neutral: #E6D7C3;    /* Sable */
            --white: #FFFFFF;             /* Blanc Pur */
            
            /* Semantic Colors */
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #C8D0C3;           /* Vert Sauge pour succ√®s */
            --info: #8FAFB1;              /* Mer pour info */
            
            /* Backgrounds */
            --bg-light: #FFFFFF;          /* Fond blanc pur */
            --bg-accent: #E6D7C3;         /* Fond sable */
            --bg-dark: #0f172a;
            
            /* Text */
            --text-light: #333333;
            --text-dark: #e2e8f0;
            --text-muted: #666666;
            
            /* Borders */
            --border-light: #D8CDBB;      /* Beige Sable */
            --border-dark: #334155;
            
            /* Depth Gauge Colors */
            --gauge-low: #ef4444;
            --gauge-medium: #f59e0b;
            --gauge-high: #C8D0C3;        /* Vert Sauge */
            
            /* Animation */
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ============================================
           RESET & BASE
        ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-light);
            color: var(--text-light);
            line-height: 1.6;
            transition: background var(--transition), color var(--transition);
        }

        body.dark {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        /* ============================================
           LAYOUT
        ============================================ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: white;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: 100;
            transition: background var(--transition), border-color var(--transition);
        }

        body.dark .header {
            background: #1e293b;
            border-color: var(--border-dark);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .badge-premium {
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(143, 175, 177, 0.3);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .timer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .control-btn {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background var(--transition);
        }

        .control-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        body.dark .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .main-container {
            margin-top: 70px;
            height: calc(100vh - 70px);
            display: flex;
            position: relative;
        }

        /* ============================================
           WELCOME SCREEN
        ============================================ */
        .welcome-screen {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .welcome-content {
            text-align: center;
            color: white;
            max-width: 600px;
            padding: 2rem;
        }

        .welcome-content h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .welcome-content p {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .start-btn {
            background: white;
            color: #8FAFB1;
            border: none;
            padding: 1rem 3rem;
            font-size: 1.125rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 10px 30px rgba(143, 175, 177, 0.3);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        /* ============================================
           WARMUP MODAL
        ============================================ */
        .warmup-modal {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .warmup-modal.active {
            display: flex;
        }

        .warmup-content {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        body.dark .warmup-content {
            background: #1e293b;
        }

        .warmup-progress {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .warmup-dot {
            flex: 1;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            transition: background 0.3s;
        }

        .warmup-dot.active {
            background: var(--primary);
        }

        .warmup-question {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2rem;
            text-align: center;
        }

        .warmup-options {
            display: grid;
            gap: 1rem;
        }

        .warmup-option {
            background: var(--bg-light);
            border: 2px solid var(--border-light);
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 1.125rem;
        }

        body.dark .warmup-option {
            background: #0f172a;
            border-color: var(--border-dark);
        }

        .warmup-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .warmup-result {
            text-align: center;
            padding: 2rem 0;
        }

        .warmup-result h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .warmup-result p {
            font-size: 1.125rem;
            color: #64748b;
            margin-bottom: 2rem;
        }

        /* ============================================
           CHAT INTERFACE
        ============================================ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--secondary);
        }

        .message-content {
            background: white;
            padding: 1rem 1.25rem;
            border-radius: 18px;
            max-width: 70%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        body.dark .message-content {
            background: #1e293b;
        }

        .message.user .message-content {
            background: var(--primary);
            color: white;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* ============================================
           INPUT AREA
        ============================================ */
        .input-container {
            padding: 1.5rem 0;
            border-top: 1px solid var(--border-light);
        }

        body.dark .input-container {
            border-color: var(--border-dark);
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .input-area {
            flex: 1;
            resize: none;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 1rem;
            font-family: inherit;
            font-size: 1rem;
            min-height: 60px;
            max-height: 200px;
            transition: border-color 0.2s;
        }

        body.dark .input-area {
            background: #1e293b;
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .input-area:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-btn, .voice-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover, .voice-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .voice-btn.recording {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ============================================
           REVELATIONS PANEL
        ============================================ */
        .revelations-panel {
            position: fixed;
            right: -400px;
            top: 70px;
            width: 380px;
            height: calc(100vh - 70px);
            background: white;
            border-left: 1px solid var(--border-light);
            transition: right 0.3s ease;
            z-index: 50;
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
        }

        body.dark .revelations-panel {
            background: #1e293b;
            border-color: var(--border-dark);
        }

        .revelations-panel.open {
            right: 0;
        }

        .revelations-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark .revelations-header {
            border-color: var(--border-dark);
        }

        .revelations-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .revelations-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .revelation-progress {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        body.dark .revelation-progress {
            background: #0f172a;
        }

        .progress-bar-container {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #64748b;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .badge-item {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            position: relative;
            transition: all 0.3s;
        }

        body.dark .badge-item {
            background: #0f172a;
        }

        .badge-item.unlocked {
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(143, 175, 177, 0.3);
        }

        .badge-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .badge-item.locked .badge-icon {
            opacity: 0.3;
        }

        .badge-title {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .badge-milestone {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .insights-section {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.5rem;
        }

        body.dark .insights-section {
            background: #0f172a;
        }

        .insights-section h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .insight-item {
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-left: 3px solid var(--primary);
        }

        body.dark .insight-item {
            background: #1e293b;
        }

        .revelations-toggle {
            position: fixed;
            right: 1rem;
            bottom: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(143, 175, 177, 0.3);
            z-index: 60;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .revelations-toggle:hover {
            transform: translateY(-2px) scale(1.05);
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ============================================
           DEPTH GAUGE
        ============================================ */
        .depth-gauge {
            position: fixed;
            left: 2rem;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            z-index: 40;
        }

        .gauge-container {
            background: white;
            border-radius: 30px;
            padding: 1rem 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body.dark .gauge-container {
            background: #1e293b;
        }

        .gauge-bar {
            width: 20px;
            height: 200px;
            background: #e2e8f0;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin: 0 auto 1rem;
        }

        .gauge-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0%;
            background: linear-gradient(to top, var(--gauge-low), var(--gauge-medium), var(--gauge-high));
            transition: height 0.5s ease, background 0.3s ease;
            border-radius: 10px;
        }

        .gauge-percentage {
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .gauge-label {
            text-align: center;
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
        }

        /* ============================================
           REFLECTION PAUSE MODAL
        ============================================ */
        .reflection-modal {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 998;
        }

        .reflection-modal.active {
            display: flex;
        }

        .reflection-content {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        body.dark .reflection-content {
            background: #1e293b;
        }

        .reflection-content h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .reflection-question {
            font-size: 1.25rem;
            color: #64748b;
            margin: 2rem 0;
            font-style: italic;
        }

        .breathing-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8FAFB1 0%, #C8D0C3 100%);
            margin: 2rem auto;
            animation: breathe 4s infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        .reflection-timer {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
            margin: 2rem 0;
        }

        .reflection-notes {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            margin: 1rem 0;
        }

        body.dark .reflection-notes {
            background: #0f172a;
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .reflection-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .reflection-buttons button {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-light);
        }

        body.dark .btn-secondary {
            background: #0f172a;
            color: var(--text-dark);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* ============================================
           STATS PANEL
        ============================================ */
        .stats-panel {
            position: fixed;
            top: 70px;
            right: 1rem;
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 45;
        }

        body.dark .stats-panel {
            background: #1e293b;
        }

        .stats-panel.active {
            display: block;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark .stat-item {
            border-color: var(--border-dark);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
        }

        .stat-value {
            font-weight: 600;
            color: var(--primary);
        }

        /* ============================================
           TOAST NOTIFICATIONS
        ============================================ */
        .toast-container {
            position: fixed;
            top: 90px;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        body.dark .toast {
            background: #1e293b;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.info {
            border-left: 4px solid var(--info);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast.danger {
            border-left: 4px solid var(--danger);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* ============================================
           LOADING OVERLAY
        ============================================ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           RESPONSIVE
        ============================================ */
        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
            }

            .logo {
                font-size: 1rem;
            }

            .timer {
                display: none;
            }

            .chat-container {
                padding: 1rem;
            }

            .message-content {
                max-width: 85%;
            }

            .revelations-panel {
                width: 100%;
                right: -100%;
            }

            .depth-gauge {
                left: 1rem;
                transform: translateY(-50%) scale(0.8);
            }

            .revelations-toggle {
                right: 1rem;
                bottom: 1rem;
                width: 50px;
                height: 50px;
            }
        }

        /* ============================================
           UTILITIES
        ============================================ */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            üß† Clone de Personnalit√©
            <span class="badge-premium">Premium</span>
        </div>
        <div class="header-controls">
            <div class="timer" id="timer">‚è±Ô∏è 00:00</div>
            <button class="control-btn" id="statsToggle" title="Statistiques">üìä</button>
            <button class="control-btn" id="themeToggle" title="Changer le th√®me">üåì</button>
            <button class="control-btn" id="pauseBtn" title="Pause">‚è∏Ô∏è</button>
            <button class="control-btn" id="exportBtn" title="Exporter">üíæ</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-content">
                <h1>Bienvenue üëã</h1>
                <p>Cr√©ons ensemble votre clone de personnalit√© uploadable dans une IA. Cette interview dure environ 45-65 minutes et g√©n√®re un profil unique de 25-30k mots.</p>
                <button class="start-btn" id="startBtn">üöÄ Commencer l'aventure</button>
            </div>
        </div>

        <!-- Warm-up Modal -->
        <div class="warmup-modal" id="warmupModal">
            <div class="warmup-content">
                <div class="warmup-progress" id="warmupProgress"></div>
                <div id="warmupQuestionContainer"></div>
            </div>
        </div>

        <!-- Depth Gauge -->
        <div class="depth-gauge">
            <div class="gauge-container">
                <div class="gauge-bar">
                    <div class="gauge-fill" id="gaugeFill"></div>
                </div>
                <div class="gauge-percentage" id="gaugePercentage">0%</div>
                <div class="gauge-label">Profondeur</div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="messages" id="messages">
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            
            <div class="input-container" id="inputContainer">
                <div class="input-wrapper">
                    <textarea 
                        id="inputArea" 
                        class="input-area" 
                        placeholder="√âcrivez votre r√©ponse..."
                        rows="2"
                    ></textarea>
                    <button class="voice-btn" id="voiceBtn" title="Dict√©e vocale">üé§</button>
                    <button class="send-btn" id="sendBtn">‚û§</button>
                </div>
            </div>
        </div>

        <!-- Revelations Panel -->
        <div class="revelations-panel" id="revelationsPanel">
            <div class="revelations-header">
                <h3>‚ú® R√©v√©lations</h3>
                <button class="control-btn" id="closeRevelations">‚úï</button>
            </div>
            <div class="revelations-content">
                <div class="revelation-progress">
                    <h4>Progression</h4>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="revelationsProgress"></div>
                    </div>
                    <div class="progress-label">
                        <span id="currentResponses">0</span>
                        <span>40 r√©ponses</span>
                    </div>
                </div>

                <div class="badges-grid" id="badgesGrid">
                    <div class="badge-item locked" data-milestone="10">
                        <div class="badge-icon">üîç</div>
                        <div class="badge-title">Explorer</div>
                        <div class="badge-milestone">10 r√©ponses</div>
                    </div>
                    <div class="badge-item locked" data-milestone="20">
                        <div class="badge-icon">üß†</div>
                        <div class="badge-title">Introspectif</div>
                        <div class="badge-milestone">20 r√©ponses</div>
                    </div>
                    <div class="badge-item locked" data-milestone="30">
                        <div class="badge-icon">üéØ</div>
                        <div class="badge-title">Profond</div>
                        <div class="badge-milestone">30 r√©ponses</div>
                    </div>
                    <div class="badge-item locked" data-milestone="40">
                        <div class="badge-icon">üèÜ</div>
                        <div class="badge-title">Ma√Ætre</div>
                        <div class="badge-milestone">40 r√©ponses</div>
                    </div>
                </div>

                <div class="insights-section">
                    <h4>üí° Insights</h4>
                    <div id="insightsContainer"></div>
                </div>
            </div>
        </div>

        <!-- Revelations Toggle Button -->
        <button class="revelations-toggle" id="revelationsToggle">
            ‚ú®
            <span class="badge-count" id="badgeCount">0</span>
        </button>

        <!-- Reflection Pause Modal -->
        <div class="reflection-modal" id="reflectionModal">
            <div class="reflection-content">
                <h2>üßò Moment de R√©flexion</h2>
                <div class="breathing-circle"></div>
                <p class="reflection-question" id="reflectionQuestion"></p>
                <div class="reflection-timer" id="reflectionTimer">2:00</div>
                <textarea 
                    class="reflection-notes" 
                    id="reflectionNotes"
                    placeholder="Notes personnelles (optionnel)..."
                ></textarea>
                <div class="reflection-buttons">
                    <button class="btn-secondary" id="skipReflection">Passer</button>
                    <button class="btn-primary" id="continueReflection">Continuer</button>
                </div>
            </div>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel" id="statsPanel">
            <div class="stat-item">
                <span class="stat-label">Temps</span>
                <span class="stat-value" id="statTime">00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Questions</span>
                <span class="stat-value" id="statQuestions">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">R√©ponses</span>
                <span class="stat-value" id="statResponses">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Mots</span>
                <span class="stat-value" id="statWords">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Phase</span>
                <span class="stat-value" id="statPhase">0/6</span>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loader"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            // ‚ö†Ô∏è √Ä CONFIGURER : Remplacez par votre URL Worker Cloudflare
            WORKER_URL: 'YOUR_CLOUDFLARE_WORKER_URL_HERE',
            MODEL: 'claude-sonnet-4-20250514',
            MAX_TOKENS: 4000,
            AUTOSAVE_INTERVAL: 30000, // 30 secondes
            ENCRYPTION_KEY_STORAGE: 'clone_encryption_key',
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            messages: [],
            startTime: null,
            elapsedSeconds: 0,
            timerInterval: null,
            currentPhase: 0,
            totalPhases: 6,
            questionCount: 0,
            responseCount: 0,
            totalWords: 0,
            isPaused: false,
            recognition: null,
            warmupCompleted: false,
            warmupResults: {},
            revelationsUnlocked: 0,
            contradictions: [],
            microExpressions: {},
            contexts: {},
            reflectionNotes: [],
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elements = {
            welcomeScreen: document.getElementById('welcomeScreen'),
            warmupModal: document.getElementById('warmupModal'),
            chatContainer: document.getElementById('chatContainer'),
            inputContainer: document.getElementById('inputContainer'),
            messages: document.getElementById('messages'),
            inputArea: document.getElementById('inputArea'),
            sendBtn: document.getElementById('sendBtn'),
            voiceBtn: document.getElementById('voiceBtn'),
            timer: document.getElementById('timer'),
            typingIndicator: document.getElementById('typingIndicator'),
            themeToggle: document.getElementById('themeToggle'),
            statsToggle: document.getElementById('statsToggle'),
            statsPanel: document.getElementById('statsPanel'),
            pauseBtn: document.getElementById('pauseBtn'),
            exportBtn: document.getElementById('exportBtn'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            startBtn: document.getElementById('startBtn'),
            revelationsPanel: document.getElementById('revelationsPanel'),
            revelationsToggle: document.getElementById('revelationsToggle'),
            closeRevelations: document.getElementById('closeRevelations'),
            badgeCount: document.getElementById('badgeCount'),
            revelationsProgress: document.getElementById('revelationsProgress'),
            currentResponses: document.getElementById('currentResponses'),
            badgesGrid: document.getElementById('badgesGrid'),
            insightsContainer: document.getElementById('insightsContainer'),
            gaugeFill: document.getElementById('gaugeFill'),
            gaugePercentage: document.getElementById('gaugePercentage'),
            reflectionModal: document.getElementById('reflectionModal'),
            reflectionQuestion: document.getElementById('reflectionQuestion'),
            reflectionTimer: document.getElementById('reflectionTimer'),
            reflectionNotes: document.getElementById('reflectionNotes'),
            skipReflection: document.getElementById('skipReflection'),
            continueReflection: document.getElementById('continueReflection'),
            toastContainer: document.getElementById('toastContainer'),
        };

        // Stats elements
        const statsElements = {
            time: document.getElementById('statTime'),
            questions: document.getElementById('statQuestions'),
            responses: document.getElementById('statResponses'),
            words: document.getElementById('statWords'),
            phase: document.getElementById('statPhase'),
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        const Utils = {
            showToast(message, type = 'info', subtitle = '') {
                const icons = {
                    success: '‚úÖ',
                    info: '‚ÑπÔ∏è',
                    warning: '‚ö†Ô∏è',
                    danger: '‚ùå'
                };

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type]}</span>
                    <div class="toast-content">
                        <div class="toast-title">${message}</div>
                        ${subtitle ? `<div class="toast-message">${subtitle}</div>` : ''}
                    </div>
                `;

                elements.toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            },

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            },

            updateStats() {
                statsElements.time.textContent = Utils.formatTime(state.elapsedSeconds);
                statsElements.questions.textContent = state.questionCount;
                statsElements.responses.textContent = state.responseCount;
                statsElements.words.textContent = state.totalWords;
                statsElements.phase.textContent = `${state.currentPhase}/${state.totalPhases}`;
            },

            countWords(text) {
                return text.trim().split(/\s+/).length;
            }
        };

        // ============================================
        // MODULE 1: SIMPLE STORAGE (localStorage)
        // ============================================
        const SecureStorage = {
            save(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Storage error:', error);
                    return false;
                }
            },

            load(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('Load error:', error);
                    return null;
                }
            },

            showToast(message, type) {
                Utils.showToast(message, type);
            }
        };

        // ============================================
        // MODULE 2: WARMUP QUIZ BUZZFEED
        // ============================================
        const Warmup = {
            questions: [
                {
                    q: "ü¶∏ Si tu √©tais un super-h√©ros, lequel serais-tu ?",
                    options: [
                        { text: "Superman - Force et justice", traits: { extraversion: 1, conscientiousness: 1 } },
                        { text: "Batman - Intelligence et strat√©gie", traits: { openness: 1, conscientiousness: 1 } },
                        { text: "Wonder Woman - Courage et compassion", traits: { agreeableness: 1, emotionalStability: 1 } },
                        { text: "Spider-Man - Responsabilit√© et humour", traits: { agreeableness: 1, openness: 1 } }
                    ]
                },
                {
                    q: "üåÖ Ton weekend id√©al ?",
                    options: [
                        { text: "Aventure en plein air", traits: { extraversion: 1, openness: 1 } },
                        { text: "Soir√©e entre amis", traits: { extraversion: 1, agreeableness: 1 } },
                        { text: "Lecture et d√©tente", traits: { openness: 1, conscientiousness: 1 } },
                        { text: "Projet cr√©atif", traits: { openness: 1, conscientiousness: 1 } }
                    ]
                },
                {
                    q: "‚ú® Quel superpouvoir choisirais-tu ?",
                    options: [
                        { text: "Lire les pens√©es", traits: { openness: 1, agreeableness: 1 } },
                        { text: "Voyager dans le temps", traits: { openness: 1, conscientiousness: 1 } },
                        { text: "Voler", traits: { extraversion: 1, openness: 1 } },
                        { text: "Invisibilit√©", traits: { emotionalStability: 1, openness: 1 } }
                    ]
                },
                {
                    q: "üêæ Ton animal totem ?",
                    options: [
                        { text: "Lion - Leadership", traits: { extraversion: 1, conscientiousness: 1 } },
                        { text: "Dauphin - Sociabilit√©", traits: { extraversion: 1, agreeableness: 1 } },
                        { text: "Hibou - Sagesse", traits: { openness: 1, conscientiousness: 1 } },
                        { text: "Chat - Ind√©pendance", traits: { emotionalStability: 1, openness: 1 } }
                    ]
                },
                {
                    q: "üåà Ta couleur pr√©f√©r√©e ?",
                    options: [
                        { text: "Rouge - Passion", traits: { extraversion: 1, emotionalStability: 1 } },
                        { text: "Bleu - S√©r√©nit√©", traits: { emotionalStability: 1, agreeableness: 1 } },
                        { text: "Vert - Harmonie", traits: { agreeableness: 1, conscientiousness: 1 } },
                        { text: "Violet - Cr√©ativit√©", traits: { openness: 1, extraversion: 1 } }
                    ]
                },
                {
                    q: "üåç Destination de r√™ve ?",
                    options: [
                        { text: "Tokyo - Technologie", traits: { openness: 1, conscientiousness: 1 } },
                        { text: "Bali - Nature", traits: { emotionalStability: 1, openness: 1 } },
                        { text: "New York - Action", traits: { extraversion: 1, conscientiousness: 1 } },
                        { text: "Islande - Solitude", traits: { emotionalStability: 1, openness: 1 } }
                    ]
                },
                {
                    q: "üé¨ Genre de film favori ?",
                    options: [
                        { text: "Action/Aventure", traits: { extraversion: 1, openness: 1 } },
                        { text: "Com√©die", traits: { extraversion: 1, agreeableness: 1 } },
                        { text: "Drame psychologique", traits: { openness: 1, emotionalStability: 1 } },
                        { text: "Documentaire", traits: { conscientiousness: 1, openness: 1 } }
                    ]
                },
                {
                    q: "üçï Soir√©e id√©ale ?",
                    options: [
                        { text: "Grande f√™te", traits: { extraversion: 1, agreeableness: 1 } },
                        { text: "D√Æner intime", traits: { agreeableness: 1, emotionalStability: 1 } },
                        { text: "Projet personnel", traits: { conscientiousness: 1, openness: 1 } },
                        { text: "Repos total", traits: { emotionalStability: 1, conscientiousness: 1 } }
                    ]
                },
                {
                    q: "üé® Ta forme d'art pr√©f√©r√©e ?",
                    options: [
                        { text: "Peinture", traits: { openness: 1, conscientiousness: 1 } },
                        { text: "Musique", traits: { openness: 1, emotionalStability: 1 } },
                        { text: "Danse", traits: { extraversion: 1, openness: 1 } },
                        { text: "√âcriture", traits: { openness: 1, conscientiousness: 1 } }
                    ]
                },
                {
                    q: "üí≠ Ton plus grand r√™ve ?",
                    options: [
                        { text: "Changer le monde", traits: { extraversion: 1, agreeableness: 1 } },
                        { text: "Cr√©er quelque chose d'unique", traits: { openness: 1, conscientiousness: 1 } },
                        { text: "Vivre libre et heureux", traits: { emotionalStability: 1, openness: 1 } },
                        { text: "Ma√Ætriser mon domaine", traits: { conscientiousness: 1, extraversion: 1 } }
                    ]
                }
            ],

            currentQuestion: 0,
            results: {
                openness: 0,
                conscientiousness: 0,
                extraversion: 0,
                agreeableness: 0,
                emotionalStability: 0
            },

            start() {
                elements.warmupModal.classList.add('active');
                this.renderQuestion();
            },

            renderQuestion() {
                if (this.currentQuestion >= this.questions.length) {
                    this.showResults();
                    return;
                }

                const question = this.questions[this.currentQuestion];
                const container = document.getElementById('warmupQuestionContainer');
                
                // Progress dots
                let progressHTML = '';
                for (let i = 0; i < this.questions.length; i++) {
                    progressHTML += `<div class="warmup-dot ${i <= this.currentQuestion ? 'active' : ''}"></div>`;
                }
                document.getElementById('warmupProgress').innerHTML = progressHTML;

                // Question and options
                container.innerHTML = `
                    <div class="warmup-question">${question.q}</div>
                    <div class="warmup-options">
                        ${question.options.map((option, i) => `
                            <div class="warmup-option" onclick="Warmup.selectOption(${i})">
                                ${option.text}
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            selectOption(index) {
                const question = this.questions[this.currentQuestion];
                const option = question.options[index];
                
                // Add traits
                Object.keys(option.traits).forEach(trait => {
                    this.results[trait] += option.traits[trait];
                });

                this.currentQuestion++;
                setTimeout(() => this.renderQuestion(), 300);
            },

            showResults() {
                const totalScore = Object.values(this.results).reduce((a, b) => a + b, 0);
                const dominant = Object.entries(this.results).sort((a, b) => b[1] - a[1])[0][0];
                
                const personalities = {
                    openness: { name: "Explorateur Cr√©atif", emoji: "üé®", desc: "Tu es curieux, imaginatif et ouvert aux nouvelles exp√©riences" },
                    conscientiousness: { name: "Architecte Organis√©", emoji: "üìê", desc: "Tu es m√©thodique, fiable et tourn√© vers l'accomplissement" },
                    extraversion: { name: "Catalyseur Social", emoji: "‚ö°", desc: "Tu es √©nergique, expressif et tu t'√©panouis avec les autres" },
                    agreeableness: { name: "Harmoniseur Empathique", emoji: "ü§ù", desc: "Tu es attentionn√©, coop√©ratif et soucieux des autres" },
                    emotionalStability: { name: "Sage √âquilibr√©", emoji: "üßò", desc: "Tu es calme, r√©silient et √©motionnellement stable" }
                };

                const personality = personalities[dominant];
                state.warmupResults = { ...this.results, dominant, personality };

                const container = document.getElementById('warmupQuestionContainer');
                container.innerHTML = `
                    <div class="warmup-result">
                        <h2>${personality.emoji} ${personality.name}</h2>
                        <p>${personality.desc}</p>
                        <p style="margin-top: 1rem; color: #64748b;">Pr√™t pour l'interview approfondie ?</p>
                        <button class="start-btn" onclick="Warmup.complete()">C'est parti ! üöÄ</button>
                    </div>
                `;

                Utils.showToast('Warm-up termin√© ! Profil pr√©liminaire cr√©√©.', 'success');
            },

            complete() {
                state.warmupCompleted = true;
                elements.warmupModal.classList.remove('active');
                startInterview();
            }
        };

        // ============================================
        // MODULE 3: REVELATIONS PROGRESSIVES
        // ============================================
        const Revelations = {
            milestones: [10, 20, 30, 40],
            unlockedBadges: [],

            check() {
                const responses = state.responseCount;
                
                // Update progress bar
                const progress = (responses / 40) * 100;
                elements.revelationsProgress.style.width = `${progress}%`;
                elements.currentResponses.textContent = responses;

                // Check for milestone unlocks
                this.milestones.forEach(milestone => {
                    if (responses >= milestone && !this.unlockedBadges.includes(milestone)) {
                        this.unlockBadge(milestone);
                    }
                });

                // Generate insights based on patterns
                if (responses === 10) this.generateInsight('early');
                if (responses === 20) this.generateInsight('mid');
                if (responses === 30) this.generateInsight('deep');
                if (responses === 40) this.generateInsight('final');
            },

            unlockBadge(milestone) {
                this.unlockedBadges.push(milestone);
                state.revelationsUnlocked++;
                elements.badgeCount.textContent = state.revelationsUnlocked;

                // Unlock badge visually
                const badgeElement = document.querySelector(`[data-milestone="${milestone}"]`);
                if (badgeElement) {
                    badgeElement.classList.remove('locked');
                    badgeElement.classList.add('unlocked');
                }

                // Get badge info
                const badges = {
                    10: { icon: "üîç", title: "Explorer", message: "Premier jalon franchi ! Tu commences √† r√©v√©ler ta personnalit√©." },
                    20: { icon: "üß†", title: "Introspectif", message: "Tu creuses en profondeur ! Tes r√©ponses deviennent plus riches." },
                    30: { icon: "üéØ", title: "Profond", message: "Impressionnant ! Tu explores des aspects profonds de toi-m√™me." },
                    40: { icon: "üèÜ", title: "Ma√Ætre", message: "Bravo ! Tu as compl√©t√© un profil exceptionnel !" }
                };

                const badge = badges[milestone];
                Utils.showToast(`Badge d√©bloqu√© : ${badge.icon} ${badge.title}`, 'success', badge.message);

                // Auto-open revelations panel
                setTimeout(() => {
                    elements.revelationsPanel.classList.add('open');
                }, 500);
            },

            generateInsight(stage) {
                const messages = state.messages.filter(m => m.role === 'user');
                const totalWords = messages.reduce((sum, m) => sum + m.content.split(' ').length, 0);
                const avgLength = totalWords / messages.length;

                let insight = '';

                if (stage === 'early') {
                    if (avgLength > 50) {
                        insight = "üí° Tu t'exprimes de mani√®re d√©taill√©e et r√©fl√©chie. Continue ainsi !";
                    } else {
                        insight = "üí° Tes r√©ponses sont concises. N'h√©site pas √† d√©velopper davantage.";
                    }
                }

                if (stage === 'mid') {
                    const emotionalWords = ['ressens', '√©motion', 'sentiment', 'heureux', 'triste', 'anxieux'];
                    const emotionalCount = messages.reduce((count, m) => {
                        return count + emotionalWords.filter(word => m.content.toLowerCase().includes(word)).length;
                    }, 0);

                    if (emotionalCount > 5) {
                        insight = "üí° Tu partages tes √©motions avec authenticit√©. C'est tr√®s pr√©cieux.";
                    } else {
                        insight = "üí° Tu restes factuel. Partager tes ressentis enrichirait ton profil.";
                    }
                }

                if (stage === 'deep') {
                    const exampleWords = ['par exemple', 'une fois', 'je me souviens', 'r√©cemment'];
                    const exampleCount = messages.reduce((count, m) => {
                        return count + exampleWords.filter(word => m.content.toLowerCase().includes(word)).length;
                    }, 0);

                    if (exampleCount > 3) {
                        insight = "üí° Tes exemples concrets rendent ton clone tr√®s authentique !";
                    } else {
                        insight = "üí° Ajouter des exemples concrets enrichirait encore ton profil.";
                    }
                }

                if (stage === 'final') {
                    insight = `üí° Profil exceptionnel ! ${totalWords} mots, ${messages.length} r√©ponses. Ton clone sera d'une fid√©lit√© remarquable.`;
                }

                if (insight) {
                    const insightElement = document.createElement('div');
                    insightElement.className = 'insight-item slide-up';
                    insightElement.textContent = insight;
                    elements.insightsContainer.appendChild(insightElement);
                }
            }
        };

        // ============================================
        // MODULE 4: DEPTH GAUGE
        // ============================================
        const DepthGauge = {
            calculate() {
                const messages = state.messages.filter(m => m.role === 'user');
                if (messages.length === 0) return 0;

                let score = 0;
                let maxScore = 0;

                // Criterion 1: Average length (30 points)
                const totalWords = messages.reduce((sum, m) => sum + m.content.split(' ').length, 0);
                const avgLength = totalWords / messages.length;
                score += Math.min(avgLength / 10, 30);
                maxScore += 30;

                // Criterion 2: Vocabulary diversity (25 points)
                const allWords = messages.join(' ').toLowerCase().split(/\s+/);
                const uniqueWords = new Set(allWords);
                const diversity = (uniqueWords.size / allWords.length) * 100;
                score += Math.min(diversity * 0.4, 25);
                maxScore += 25;

                // Criterion 3: Emotional depth (20 points)
                const emotionalWords = ['ressens', '√©motion', 'sentiment', 'pense', 'crois', 'heureux', 'triste', 'anxieux', 'joie', 'peur'];
                const emotionalCount = messages.reduce((count, m) => {
                    return count + emotionalWords.filter(word => m.content.toLowerCase().includes(word)).length;
                }, 0);
                score += Math.min(emotionalCount * 2, 20);
                maxScore += 20;

                // Criterion 4: Concrete examples (15 points)
                const exampleWords = ['par exemple', 'une fois', 'je me souviens', 'r√©cemment', 'souvent'];
                const exampleCount = messages.reduce((count, m) => {
                    return count + exampleWords.filter(word => m.content.toLowerCase().includes(word)).length;
                }, 0);
                score += Math.min(exampleCount * 3, 15);
                maxScore += 15;

                // Criterion 5: Introspection depth (10 points)
                const introspectionWords = ['parce que', 'car', 'puisque', '√©tant donn√©', 'donc', 'ainsi'];
                const introspectionCount = messages.reduce((count, m) => {
                    return count + introspectionWords.filter(word => m.content.toLowerCase().includes(word)).length;
                }, 0);
                score += Math.min(introspectionCount * 2, 10);
                maxScore += 10;

                const percentage = Math.round((score / maxScore) * 100);
                return Math.min(percentage, 100);
            },

            update() {
                const percentage = this.calculate();
                elements.gaugeFill.style.height = `${percentage}%`;
                elements.gaugePercentage.textContent = `${percentage}%`;

                // Update color based on percentage
                if (percentage < 40) {
                    elements.gaugeFill.style.background = 'linear-gradient(to top, var(--gauge-low), var(--gauge-low))';
                } else if (percentage < 70) {
                    elements.gaugeFill.style.background = 'linear-gradient(to top, var(--gauge-low), var(--gauge-medium))';
                } else {
                    elements.gaugeFill.style.background = 'linear-gradient(to top, var(--gauge-low), var(--gauge-medium), var(--gauge-high))';
                }

                // Show encouraging message if low
                if (percentage < 50 && state.responseCount > 5 && state.responseCount % 5 === 0) {
                    Utils.showToast('D√©veloppe davantage tes r√©ponses pour enrichir ton profil !', 'info');
                }
            }
        };

        // ============================================
        // MODULE 5: CONTRADICTION DETECTOR
        // ============================================
        const ContradictionDetector = {
            statements: [],

            analyze(newMessage) {
                // Extract strong statements
                const strongPatterns = [
                    /je suis (tr√®s |plut√¥t |vraiment )?(.*)/gi,
                    /j'(aime|adore|d√©teste|pr√©f√®re) (.*)/gi,
                    /je (ne |n')?(.*) (jamais|toujours|souvent|rarement)/gi
                ];

                strongPatterns.forEach(pattern => {
                    const matches = newMessage.content.matchAll(pattern);
                    for (const match of matches) {
                        this.statements.push({
                            text: match[0],
                            messageIndex: state.messages.length - 1,
                            context: newMessage.content.substring(Math.max(0, match.index - 50), Math.min(newMessage.content.length, match.index + 100))
                        });
                    }
                });

                // Check for contradictions
                if (this.statements.length > 5) {
                    this.detectContradictions();
                }
            },

            detectContradictions() {
                // Simple contradiction detection
                console.log('Statements analyzed:', this.statements.length);
            }
        };

        // ============================================
        // MODULE 6: MICRO-EXPRESSIONS ANALYZER
        // ============================================
        const MicroExpressions = {
            analyze() {
                const messages = state.messages.filter(m => m.role === 'user');
                
                return {
                    pronouns: this.analyzePronouns(messages),
                    tenses: this.analyzeTenses(messages),
                    abstractness: this.analyzeAbstractness(messages),
                    negations: this.analyzeNegations(messages)
                };
            },

            analyzePronouns(messages) {
                const text = messages.map(m => m.content).join(' ').toLowerCase();
                const jeCount = (text.match(/\bje\b/g) || []).length;
                const nousCount = (text.match(/\bnous\b/g) || []).length;
                const onCount = (text.match(/\bon\b/g) || []).length;
                
                return {
                    je: jeCount,
                    nous: nousCount,
                    on: onCount,
                    ratio: jeCount / (nousCount + onCount + 1)
                };
            },

            analyzeTenses(messages) {
                const text = messages.map(m => m.content).join(' ').toLowerCase();
                const pastMarkers = ['√©tais', 'avais', 'faisais', 'ai √©t√©', 'ai fait'];
                const presentMarkers = ['suis', 'ai', 'fais', 'vais'];
                const futureMarkers = ['serai', 'aurai', 'ferai', 'vais'];
                
                let past = 0, present = 0, future = 0;
                pastMarkers.forEach(marker => past += (text.match(new RegExp(marker, 'g')) || []).length);
                presentMarkers.forEach(marker => present += (text.match(new RegExp(marker, 'g')) || []).length);
                futureMarkers.forEach(marker => future += (text.match(new RegExp(marker, 'g')) || []).length);
                
                return { past, present, future };
            },

            analyzeAbstractness(messages) {
                const text = messages.map(m => m.content).join(' ').toLowerCase();
                const abstractWords = ['concept', 'id√©e', 'th√©orie', 'principe', 'valeur', 'croyance'];
                const concreteWords = ['par exemple', 'une fois', 'r√©cemment', 'hier', 'moment'];
                
                let abstract = 0, concrete = 0;
                abstractWords.forEach(word => abstract += (text.match(new RegExp(word, 'g')) || []).length);
                concreteWords.forEach(word => concrete += (text.match(new RegExp(word, 'g')) || []).length);
                
                return { abstract, concrete, ratio: abstract / (concrete + 1) };
            },

            analyzeNegations(messages) {
                const text = messages.map(m => m.content).join(' ').toLowerCase();
                const negations = (text.match(/\b(ne |n'|pas |jamais |rien |personne )/g) || []).length;
                const totalWords = text.split(/\s+/).length;
                
                return {
                    count: negations,
                    percentage: (negations / totalWords) * 100
                };
            }
        };

        // ============================================
        // MODULE 7: CONTEXTUAL ANALYSIS
        // ============================================
        const ContextualAnalysis = {
            contexts: {
                professional: { name: "Professionnel", icon: "üíº", questions: [] },
                intimate: { name: "Intime", icon: "‚ù§Ô∏è", questions: [] },
                social: { name: "Social", icon: "üë•", questions: [] },
                solitary: { name: "Solitaire", icon: "üßò", questions: [] },
                stress: { name: "Sous stress", icon: "‚ö°", questions: [] }
            },

            detectContext(question) {
                const q = question.toLowerCase();
                
                if (q.includes('travail') || q.includes('professionnel') || q.includes('coll√®gue')) {
                    return 'professional';
                }
                if (q.includes('proche') || q.includes('intime') || q.includes('ami') || q.includes('famille')) {
                    return 'intimate';
                }
                if (q.includes('groupe') || q.includes('social') || q.includes('r√©union')) {
                    return 'social';
                }
                if (q.includes('seul') || q.includes('solitaire') || q.includes('isol√©')) {
                    return 'solitary';
                }
                if (q.includes('stress') || q.includes('pression') || q.includes('difficult√©')) {
                    return 'stress';
                }
                
                return null;
            },

            addResponse(context, question, response) {
                if (!this.contexts[context]) return;
                
                this.contexts[context].questions.push({
                    question,
                    response,
                    timestamp: Date.now()
                });
                
                state.contexts[context] = this.contexts[context];
            }
        };

        // ============================================
        // API COMMUNICATION
        // ============================================
        async function sendToAPI(userMessage) {
            elements.typingIndicator.classList.add('active');
            elements.sendBtn.disabled = true;

            try {
                const response = await fetch(CONFIG.WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: CONFIG.MODEL,
                        max_tokens: CONFIG.MAX_TOKENS,
                        messages: state.messages
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                return data.content[0].text;

            } catch (error) {
                console.error('API Error:', error);
                Utils.showToast('Erreur de connexion. V√©rifiez votre configuration.', 'danger');
                return null;
            } finally {
                elements.typingIndicator.classList.remove('active');
                elements.sendBtn.disabled = false;
            }
        }

        // ============================================
        // MESSAGE HANDLING
        // ============================================
        function addMessage(role, content) {
            state.messages.push({ role, content });

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-avatar">${role === 'assistant' ? 'üß†' : 'üë§'}</div>
                <div class="message-content">${content}</div>
            `;

            elements.messages.appendChild(messageDiv);
            elements.messages.scrollTop = elements.messages.scrollHeight;

            if (role === 'user') {
                state.responseCount++;
                state.totalWords += Utils.countWords(content);
                Utils.updateStats();
                
                // Update modules
                Revelations.check();
                DepthGauge.update();
                ContradictionDetector.analyze({ role, content });
                
                // Detect context
                const lastAssistantMsg = [...state.messages].reverse().find(m => m.role === 'assistant');
                if (lastAssistantMsg) {
                    const context = ContextualAnalysis.detectContext(lastAssistantMsg.content);
                    if (context) {
                        ContextualAnalysis.addResponse(context, lastAssistantMsg.content, content);
                    }
                }
            }

            if (role === 'assistant') {
                state.questionCount++;
                Utils.updateStats();
            }

            // Auto-save
            saveProgress();
        }

        async function sendMessage() {
            const message = elements.inputArea.value.trim();
            if (!message) return;

            addMessage('user', message);
            elements.inputArea.value = '';
            elements.inputArea.style.height = 'auto';

            const response = await sendToAPI(message);
            if (response) {
                addMessage('assistant', response);
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            // Event listeners
            elements.startBtn.addEventListener('click', () => {
                elements.welcomeScreen.classList.add('hidden');
                setTimeout(() => Warmup.start(), 500);
            });

            elements.sendBtn.addEventListener('click', sendMessage);
            elements.inputArea.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            elements.inputArea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Revelations panel
            elements.revelationsToggle.addEventListener('click', () => {
                elements.revelationsPanel.classList.toggle('open');
            });

            elements.closeRevelations.addEventListener('click', () => {
                elements.revelationsPanel.classList.remove('open');
            });

            // Theme toggle
            elements.themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
            });

            // Stats toggle
            elements.statsToggle.addEventListener('click', () => {
                elements.statsPanel.classList.toggle('active');
            });

            // Pause button
            elements.pauseBtn.addEventListener('click', togglePause);

            // Export button
            elements.exportBtn.addEventListener('click', exportProfile);

            // Start timer
            startTimer();
        }

        function startInterview() {
            elements.chatContainer.style.display = 'flex';
            
            // Initial message
            const initialMessage = `Bonjour ! Je suis ravi de cr√©er ton clone de personnalit√©. Cette interview va nous permettre de capturer ton essence unique en 45-65 minutes.\n\nJe vais te poser des questions sur diff√©rents aspects de ta personnalit√©. R√©ponds spontan√©ment et honn√™tement - il n'y a pas de bonne ou mauvaise r√©ponse.\n\nCommen√ßons : Peux-tu te pr√©senter en quelques lignes ? Qui es-tu ?`;
            
            addMessage('assistant', initialMessage);
        }

        function startTimer() {
            state.startTime = Date.now();
            state.timerInterval = setInterval(() => {
                if (!state.isPaused) {
                    state.elapsedSeconds++;
                    elements.timer.textContent = `‚è±Ô∏è ${Utils.formatTime(state.elapsedSeconds)}`;
                    Utils.updateStats();
                }
            }, 1000);
        }

        function togglePause() {
            state.isPaused = !state.isPaused;
            elements.pauseBtn.textContent = state.isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
            Utils.showToast(state.isPaused ? 'Interview en pause' : 'Interview reprise', 'info');
        }

        function saveProgress() {
            const profileData = {
                messages: state.messages,
                stats: {
                    elapsedSeconds: state.elapsedSeconds,
                    questionCount: state.questionCount,
                    responseCount: state.responseCount,
                    totalWords: state.totalWords
                },
                warmup: state.warmupResults,
                revelations: state.revelationsUnlocked,
                contexts: state.contexts,
                timestamp: Date.now()
            };

            SecureStorage.save('clone_profile_v8', profileData);
        }

        async function exportProfile() {
            elements.loadingOverlay.classList.add('active');

            try {
                // Generate comprehensive profile
                const profile = {
                    metadata: {
                        version: '8.0 ULTIMATE - Institut du Couple',
                        created: new Date().toISOString(),
                        duration: state.elapsedSeconds,
                        questionCount: state.questionCount,
                        responseCount: state.responseCount,
                        totalWords: state.totalWords
                    },
                    warmup: state.warmupResults,
                    messages: state.messages,
                    revelations: {
                        unlockedBadges: Revelations.unlockedBadges,
                        insights: Array.from(elements.insightsContainer.children).map(el => el.textContent)
                    },
                    depthGauge: {
                        score: DepthGauge.calculate(),
                        breakdown: 'Calculated based on length, diversity, emotion, examples, introspection'
                    },
                    microExpressions: MicroExpressions.analyze(),
                    contexts: state.contexts,
                    contradictions: state.contradictions,
                    reflectionNotes: state.reflectionNotes
                };

                // Export JSON
                const jsonBlob = new Blob([JSON.stringify(profile, null, 2)], { type: 'application/json' });
                const jsonUrl = URL.createObjectURL(jsonBlob);
                const jsonA = document.createElement('a');
                jsonA.href = jsonUrl;
                jsonA.download = `clone-personality-v8-${Date.now()}.json`;
                jsonA.click();

                Utils.showToast('Profil export√© avec succ√®s !', 'success', 'Fichier JSON t√©l√©charg√©');
            } catch (error) {
                console.error('Export error:', error);
                Utils.showToast('Erreur lors de l\'export', 'danger');
            } finally {
                elements.loadingOverlay.classList.remove('active');
            }
        }

        // ============================================
        // START APPLICATION
        // ============================================
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>        // ====================
